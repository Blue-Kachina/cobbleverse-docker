# Cobbleverse Docker Compose
# Version: 1.0.0 (2025-11-01)
services:
  mc:
    image: itzg/minecraft-server:latest
    container_name: "${SERVER_NAME:-cobbleverse-server-mc}-mc"
    restart: unless-stopped
    ports:
      - "25565:25565" #Minecraft
      - "25575:25575" #Rcon

    volumes:
      - ./data:/data
      - ./backups:/backups
      - ./scripts/init:/container-init.d
    # Ensure init scripts are executable (on Windows/WSL the +x bit can be lost)
    entrypoint: ["/bin/sh", "-c", "d=/container-init.d; echo '[compose:init] listing ' $$d; ls -la $$d 2>/dev/null || echo '[compose:init] ' $$d ' (missing)'; cnt=$$(ls -1 $$d/*.sh 2>/dev/null | wc -l); echo \"[compose:init] found $$cnt .sh files in $$d\"; chmod +x $$d/* 2>/dev/null || true; if [ \"$$cnt\" -gt 0 ]; then for f in $$d/*.sh; do [ -e \"$$f\" ] || continue; echo \"[compose:init] running $$f\"; \"$$f\" || echo \"[compose:init] $$f exited with $$?\"; done; fi; exec /start"]
    env_file:
      - .env
    environment:
      EULA: "TRUE"
      TYPE: "MODRINTH"
      USE_AIKAR_FLAGS: "true"
      MEMORY: "${MEMORY:-8G}"
      MODRINTH_MODPACK: "${MODRINTH_MODPACK:-}"
      MODRINTH_URL: "${MODRINTH_URL:-}"
      GENERIC_PACK: "${GENERIC_PACK:-}"
      MODRINTH_PROJECT: "${MODRINTH_PROJECT:-Jkb29YJU}"
      MODRINTH_VERSION: "${MODRINTH_VERSION:-}"
      MODRINTH_DOWNLOAD_DEPENDENCIES: "optional"
      USE_MODPACK_CACHE: "true"
      REMOVE_OLD_MODS: "true"
      OVERRIDE_SERVER_PROPERTIES: "true"
      MOTD: "${SERVER_MOTD:-}"
      DEBUG: "true"
      TZ: "${TZ:-UTC}"
      UID: "${UID:-1000}"
      GID: "${GID:-1000}"

      ENABLE_AUTOPAUSE: "false"
      ENABLE_AUTOSTOP: "false"
      JVM_OPTS: "${JVM_OPTS:-}"
      RESTART_ON_CRASH: "${RESTART_ON_CRASH:-}"
      MAX_TICK_TIME: "${MAX_TICK_TIME:-}"
      ENABLE_ROLLING_LOGS: "true"
      STOP_SERVER_ANNOUNCE_DELAY: "${STOP_SERVER_ANNOUNCE_DELAY:-15}"
      # RCON is enabled when a password is provided
      RCON_PASSWORD: "${RCON_PASSWORD:-}"
      RCON_CMDS_STARTUP: "${RCON_CMDS_STARTUP:-}"
      # Map our SERVER_ICON (or leave empty) to the base image's ICON env
      ICON: "${SERVER_ICON:-}"
    labels:
      - "org.bluekachina.project=cobbleverse-docker"
      - "org.bluekachina.version=1.0.0"
      - "org.bluekachina.phase=10"
    # Uncomment if you want simple health insight
    # healthcheck:
    #   test: ["CMD", "/usr/lib/mc-monitor", "status", "--host", "localhost", "--port", "25565"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 5

  mc-backup:
    image: itzg/mc-backup:latest
    container_name: "${SERVER_NAME:-cobbleverse-server-backup}-backup"
    restart: unless-stopped
    # Run as root to ensure write access to host-mounted ./backups on all platforms
    # (mc container still runs as non-root UID/GID for data directory security)
    user: "0:0"
    depends_on:
      - mc
    env_file:
      - .env
    environment:
      TZ: "${TZ:-UTC}"
      BACKUP_INTERVAL: "${BACKUP_INTERVAL:-24h}"
      PRUNE_BACKUPS_DAYS: "${BACKUP_PRUNE_DAYS:-14}"
      # Use tar archives in /backups; include world and configs under /data
      BACKUP_METHOD: tar
      # RCON settings so backup can quiesce the server during snapshots
      RCON_HOST: mc
      RCON_PORT: 25575
      # Pass through the same password used by the mc service; when empty, rcon is disabled
      RCON_PASSWORD: "${RCON_PASSWORD:-}"
    volumes:
      - ./data:/data:ro
      - ./backups:/backups

  mc-backup-prune:
    image: alpine:3.20
    container_name: "${SERVER_NAME:-cobbleverse-server-backup}-pruner"
    restart: unless-stopped
    depends_on:
      - mc-backup
    env_file:
      - .env
    environment:
      TZ: "${TZ:-UTC}"
      BACKUP_MAX_BACKUPS: "${BACKUP_MAX_BACKUPS:-0}"
    volumes:
      - ./backups:/backups
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "-c", "while true; do /bin/sh /scripts/prune-backups.sh; sleep 60; done"]

